: 4_0

1 LINE.NUM
  %ScratchPad 
  200  
  ^rtTestActive   IO.SP.READ
  ^GetScratchPadResult @! 

2 LINE.NUM
  %ScratchPad 
  1  
  5    IO.SP.I.WRITE
  ^GetScratchPadResult @! 

3 LINE.NUM
  *StrategyRunTime   TIME>$
13 JUMP ;
: 4_7

1 LINE.NUM
  ^rtTestRunTime   StartTimer
0 JUMP ;
: 4_8
1 LINE.NUM ^rtTestRunTime @@F  Truncate ^rtCurrentRunTime @! 
3 LINE.NUM ^rtCurrentRunTime @@ 1 I>F F+ ^rtTotalSecondsOfTest @@F F>= IF 
4 LINE.NUM ^rtTotalSecondsOfTest @@ 1 -  }rtSpeedPerSecond TABLE@ ^rtRequiredSpeed @! 
5 LINE.NUM ELSE 
6 LINE.NUM ^rtCurrentRunTime @@ 1 I>F F+ ^rtLowerBoundReqSpeedIndex @! 
7 LINE.NUM ^rtCurrentRunTime @@ 2 I>F F+ ^rtUpperBoundReqSpeedIndex @! 
9 LINE.NUM ^rtUpperBoundReqSpeedIndex @@I }rtSpeedPerSecond TABLE@ ^rtLowerBoundReqSpeedIndex @@I }rtSpeedPerSecond TABLE@ F- ^rtUpperBoundReqSpeedIndex @@ ^rtLowerBoundReqSpeedIndex @@ F- F/  FABS ^rtSlope @! 
11 LINE.NUM ^rtUpperBoundReqSpeedIndex @@I }rtSpeedPerSecond TABLE@ ^rtSlope @@ ^rtUpperBoundReqSpeedIndex @@ F* F- ^rtIntercept @! 
13 LINE.NUM ^rtSlope @@ ^rtTestRunTime @@F 1.000000e+000 F+ F* ^rtIntercept @@ F+ ^rtRequiredSpeed @! 
14 LINE.NUM THEN 
5 JUMP ;
: 4_10
-2 JUMP ;
: 4_11

1 LINE.NUM
  0  
  ^rtCurrentSpeed I@!   

2 LINE.NUM
  ^rtTestRunTime   StopTimer

3 LINE.NUM
  &Road_Test   STOP.T
10 JUMP ;
: 4_13
2 LINE.NUM }rtAccelerationPoints  TableSize@ ^gLengthOfTable @! 
3 LINE.NUM 0 ^rtNumberOfAccPoints @! 
4 LINE.NUM 0 ^gIndex @! 
5 LINE.NUM BEGIN ^gIndex @@ ^gLengthOfTable @@ < WHILE 
7 LINE.NUM ^gIndex @@ }rtAccelerationPoints TABLE@ 0 I>F F< IF 
8 LINE.NUM ^gLengthOfTable @@ ^gIndex @! 
9 LINE.NUM ELSE 
10 LINE.NUM ^rtNumberOfAccPoints @@ 1 +  ^rtNumberOfAccPoints @! 
11 LINE.NUM ^gIndex @@ }rtAccelerationPoints TABLE@ ^rtCurrentAcceleration @@ F= IF 
12 LINE.NUM ^gIndex @@ ^rtAccelerationIndex @! 
13 LINE.NUM THEN 
14 LINE.NUM THEN 
15 LINE.NUM ^gIndex @@ 1 +  ^gIndex @! 
16 LINE.NUM REPEAT 
19 LINE.NUM }rtSpeedPoints  TableSize@ ^gLengthOfTable @! 
20 LINE.NUM 0 ^gIndex @! 
21 LINE.NUM -1 ^rtSpeedIndex @! 
22 LINE.NUM BEGIN ^gIndex @@ ^gLengthOfTable @@ < WHILE 
23 LINE.NUM ^gIndex @@ }rtSpeedPoints TABLE@ ^rtCurrentSpeed @@ F= IF 
24 LINE.NUM ^gIndex @@ ^rtSpeedIndex @! 
25 LINE.NUM ^gLengthOfTable @@ ^gIndex @! 
26 LINE.NUM ELSE 
27 LINE.NUM ^gIndex @@ }rtSpeedPoints TABLE@ ^rtCurrentSpeed @@ F> IF 
28 LINE.NUM ^gIndex @@ ^rtUpperBoundSpeedIndex @! 
29 LINE.NUM ^gIndex @@ 1 -  ^rtLowerBoundSpeedIndex @! 
30 LINE.NUM ^gLengthOfTable @@ ^gIndex @! 
31 LINE.NUM ELSE 
32 LINE.NUM ^gIndex @@ }rtSpeedPoints TABLE@ ^rtCurrentSpeed @@ F< IF 
33 LINE.NUM ^gIndex @@ 1 +  ^gIndex @! 
34 LINE.NUM THEN 
35 LINE.NUM THEN 
36 LINE.NUM THEN 
37 LINE.NUM REPEAT 
39 LINE.NUM ^rtSpeedIndex @@ 0 >= IF 
40 LINE.NUM ^rtSpeedIndex @@ ^rtNumberOfAccPoints @@ *  ^rtAccelerationIndex @@ +  ^rtThrottleSetPointIndex @! 
42 LINE.NUM ^rtThrottleSetPointIndex @@ }rtTSPGear1 TABLE@ 10 I>F F/ ^rtThrottleSetPoint @! 
43 LINE.NUM ELSE 
44 LINE.NUM ^rtUpperBoundSpeedIndex @@ ^rtNumberOfAccPoints @@ *  ^rtAccelerationIndex @@ +  ^rtUpperBoundSetPointIndex @! 
45 LINE.NUM ^rtLowerBoundSpeedIndex @@ ^rtNumberOfAccPoints @@ *  ^rtAccelerationIndex @@ +  ^rtLowerBoundSetPointIndex @! 
47 LINE.NUM ^rtUpperBoundSetPointIndex @@ }rtTSPGear1 TABLE@ ^rtLowerBoundSetPointIndex @@ }rtTSPGear1 TABLE@ F- ^rtUpperBoundSpeedIndex @@ }rtSpeedPoints TABLE@ ^rtLowerBoundSpeedIndex @@ }rtSpeedPoints TABLE@ F- F/  FABS ^rtSlope @! 
49 LINE.NUM ^rtUpperBoundSetPointIndex @@ }rtTSPGear1 TABLE@ ^rtSlope @@ ^rtUpperBoundSpeedIndex @@ }rtSpeedPoints TABLE@ F* F- ^rtIntercept @! 
51 LINE.NUM ^rtSlope @@ ^rtCurrentSpeed @@ F* ^rtIntercept @@ F+ 10 I>F F/ ^rtThrottleSetPoint @! 
52 LINE.NUM THEN 
54 LINE.NUM %ScratchPad 200 ^rtCurrentSpeed @@  IO.SP.F.WRITE DROP  
55 LINE.NUM %ScratchPad 201 ^rtCurrentAcceleration @@  IO.SP.F.WRITE DROP  
56 LINE.NUM %ScratchPad 202 ^rtRequiredSpeed @@  IO.SP.F.WRITE DROP  
57 LINE.NUM %ScratchPad 203 ^rtThrottleSetPoint @@  IO.SP.F.WRITE DROP  
58 LINE.NUM %ScratchPad 204 ^rtTestRunTime @@F  IO.SP.F.WRITE DROP  
5 JUMP ;
: 4_16
2 JUMP ;
: 4_19
1 LINE.NUM %ScratchPad 20 10 0 }rtSpeedPoints  IO.SP.READ DROP  
2 LINE.NUM %ScratchPad 20 30 0 }rtAccelerationPoints  IO.SP.READ DROP  
3 LINE.NUM %ScratchPad 100 1000 0 }rtTSPGear1  IO.SP.READ DROP  
5 LINE.NUM %ScratchPad 3600 2000 0 }rtSpeedPerSecond  IO.SP.READ DROP  
7 LINE.NUM %ScratchPad 3600 2000 0 }rtSpeedPerSecond  IO.SP.READ DROP  
9 LINE.NUM %ScratchPad 10 250 0 }GearRatio  IO.SP.READ DROP  
11 LINE.NUM 0 ^rtTotalSecondsOfTest @! 
12 LINE.NUM }rtSpeedPerSecond  TableSize@ ^gLengthOfTable @! 
1 14 LINE.NUM ^gLengthOfTable @@ 1 -  1 + 0 DO? I ^gIndex @! 
15 LINE.NUM ^gIndex @@ }rtSpeedPerSecond TABLE@ 0 I>F F>= IF 
16 LINE.NUM ^rtTotalSecondsOfTest @@ 1 +  ^rtTotalSecondsOfTest @! 
17 LINE.NUM ELSE 
18 LINE.NUM ^gLengthOfTable @@ ^gIndex @! 
19 LINE.NUM THEN 
20 LINE.NUM 1 +LOOP 
23 LINE.NUM ^rtTotalSecondsOfTest @@ 1 -  ^rtTotalSecondsOfTest @! 
25 LINE.NUM |rtCalculate_Speed_Trim 0 I>F  $0001.. 3 ROLL !PID 
26 LINE.NUM |rtCalculate_Speed_Trim 0 I>F  $0008.. 3 ROLL !PID 
28 LINE.NUM |rtActuate_Throttle 0 I>F  $0001.. 3 ROLL !PID 
29 LINE.NUM |rtActuate_Throttle 0 I>F  $0008.. 3 ROLL !PID 
-7 JUMP ;
: 4_20
3 LINE.NUM ^rtRequiredSpeed @@ ^rtCurrentSpeed @@ F- ^rtCurrentAcceleration @! 
4 LINE.NUM 1 ^rtCurrentGear @! 
8 LINE.NUM ~IgnitionFrequency @@I I>F ^PulseMultiplier @@ F/ ^EngineSpeed F@! 
10 LINE.NUM ~SpeedEncoder @@I ^PulsePerRev @@ / I>F ^WheelSpeed @! 
12 LINE.NUM ^rtThrottleSetPoint @@ 0 I>F F> ^WheelSpeed @@ 0 I>F F> LAND  IF 
13 LINE.NUM ^EngineSpeed @@F ^WheelSpeed @@ F/ ^DriveTrainRatio @! 
14 LINE.NUM ELSE 
15 LINE.NUM -1 I>F ^DriveTrainRatio @! 
16 LINE.NUM THEN 
18 LINE.NUM ^DriveTrainRatio @@ 1.000000e-001 F+ ^DriveTrainRatio @! 
20 LINE.NUM 0 ^gIndex @! 
21 LINE.NUM BEGIN ^gIndex @@ 10 < WHILE 
22 LINE.NUM ^DriveTrainRatio @@ ^gIndex @@ 1 +  }GearRatio TABLE@ F> IF 
23 LINE.NUM ^gIndex @@ 1 +  ^rtCurrentGear @! 
24 LINE.NUM THEN 
25 LINE.NUM REPEAT 
27 LINE.NUM ^WheelSpeed @@ ^RollDiameter @@ F* 3.361352e+002 F/ ^rtCurrentSpeed @! 
-4 JUMP ;
: 4_21

1 LINE.NUM
  %ScratchPad 
  201  
  ^rtDataLoadStatus   IO.SP.READ
  ^gStatus @! 
3 JUMP ;
: 4_23
-11 JUMP ;
: 4_27
1 LINE.NUM |rtCalculate_Speed_Trim ^rtRequiredSpeed @@  $0002.. 3 ROLL !PID 
2 LINE.NUM |rtCalculate_Speed_Trim ^rtCurrentSpeed @@  $0001.. 3 ROLL !PID 
4 LINE.NUM |rtCalculate_Speed_Trim  $0008.. ROT PID@ ^rtPidOutput @! 
6 LINE.NUM ^rtPidOutput @@ 2.000000e-001 F* ^rtThrottleSetPoint @@ 8.000000e-001 F* F+ ^rtThrottleOutput @! 
8 LINE.NUM |rtActuate_Throttle ^rtThrottleOutput @@  $0002.. 3 ROLL !PID 
12 LINE.NUM ^rtRequiredSpeed @@ 0 I>F F> IF 
13 LINE.NUM ^rtRequiredSpeed @@ ^rtCurrentSpeed @! 
14 LINE.NUM ELSE 
15 LINE.NUM 0 I>F ^rtCurrentSpeed @! 
16 LINE.NUM THEN 
0 JUMP ;
: 4_9
TRUE

1 LINE.NUM
  ^rtCurrentRunTime @@ 
  ^rtTotalSecondsOfTest @@F   F>=
LAND
IF -9 ELSE -10 THEN JUMP ;
: 4_17
TRUE

1 LINE.NUM
  ^rtDataLoadStatus @@ 
  3    =
LAND
IF -7 ELSE -8 THEN JUMP ;
: 4_22
TRUE

1 LINE.NUM
  ^rtTestActive @@ 
  1    =
LAND
IF -6 ELSE -5 THEN JUMP ;
T: T4
DUMMY
4_0
4_7
4_8
4_10
4_11
4_13
4_16
4_19
4_20
4_21
4_23
4_27
4_9
4_17
4_22
T;
&Road_Test ' T4 SETTASK
